// =====================================================
// EMOTION ENGINE v3.0 - Decodificador de Emo√ß√µes
// =====================================================
// SEM aleatoriedade. SEM timers. SEM rota√ß√£o autom√°tica.
// S√≥ muda express√£o quando:
// 1. processMessage() √© chamado (nova conversa)
// 2. setEmotion() √© chamado diretamente (teste)
// =====================================================

import { AvatarEngine, type ExpressionName } from './AvatarEngine'

// =====================================================
// TIPOS
// =====================================================

export interface EmotionDecision {
    expression: ExpressionName
    intensity: number
    reason: string
}

export interface EmotionRequest {
    userMessage: string
    assistantReply: string
    emotionTemperature: number
}

// =====================================================
// MAPEAMENTO DE KEYWORDS ‚Üí EMO√á√ïES
// =====================================================

const EMOTION_KEYWORDS: Record<ExpressionName, string[]> = {
    happy: [
        '√≥timo', 'excelente', 'maravilhoso', 'incr√≠vel', 'parab√©ns',
        'legal', 'adorei', 'perfeito', 'sensacional', 'top', 'demais',
        'feliz', 'alegria', 'sucesso', 'conseguiu', 'fant√°stico',
        'haha', 'üòä', 'üòÑ', 'üéâ', 'amo', 'adoro', 'rsrs', 'kkk',
        'obrigado', 'valeu', 'show'
    ],
    sad: [
        'triste', 'infelizmente', 'sinto muito', 'pena',
        'problema grave', 'ruim', 'mal', 'faleceu', 'morreu', 'perda',
        'lamento', 'üò¢', 'üòî', 'chorar', 'dif√≠cil demais'
    ],
    surprised: [
        'uau', 'nossa', 's√©rio?', 'verdade?', 'n√£o acredito',
        'chocante', 'impressionante', 'inesperado', 'surpresa', 'üòÆ', 'üò≤',
        'caramba', 'puts', 'meu deus', 'inacredit√°vel'
    ],
    confused: [
        'n√£o entendi', 'como assim', 'o que?', 'confuso', 'estranho',
        'd√∫vida', 'pode explicar', 'n√£o sei', 'incerto', 'ü§î', '‚ùì',
        'n√£o faz sentido', 'hein'
    ],
    curious: [
        'como funciona', 'por que', 'o que √©', 'me conta', 'explica',
        'interessante', 'quero saber', 'curioso', 'ser√° que', 'conta mais',
        'detalhes', 'e a√≠', 'como assim'
    ],
    frustrated: [
        'n√£o funciona', 'erro', 'bug', 'problema', 'travou', 'droga',
        'frustrado', 'irritado', 'üò§', 'que saco', 'de novo n√£o'
    ],
    proud: [
        'consegui', 'fiz isso', 'orgulho', 'realizei', 'completei',
        'terminei', 'vit√≥ria', 'conquista', 'alcancei', 'üí™', 'üèÜ'
    ],
    focused: [
        'deixa eu ver', 'analisando', 'processando',
        'calculando', 'verificando', 'aguarde', 'um momento',
        'vou verificar', 'deixa eu pensar'
    ],
    bored: [
        'chato', 'entediante', 'meh', 'tanto faz', 'sei l√°', 'pregui√ßa',
        'bl√° bl√°'
    ],
    fearful: [
        'medo', 'preocupado', 'ansioso', 'nervoso', 'assustado',
        'perigoso', 'cuidado', 'alerta', 'üò∞', 'üò®'
    ],
    contempt: [
        'rid√≠culo', 'absurdo', 'pat√©tico', 'p√©ssimo', 'vergonha'
    ],
    envious: [
        'inveja', 'queria ter', 'gostaria de ter', 'sorte sua'
    ],
    neutral: []
}

// =====================================================
// CLASSE
// =====================================================

class EmotionEngineClass {
    constructor() {
        console.log('üß† EmotionEngine v3.0 inicializado (Sem aleatoriedade)')
    }

    // =====================================================
    // DEFINIR EMO√á√ÉO DIRETAMENTE (para testes)
    // =====================================================

    setEmotion(expression: ExpressionName) {
        console.log(`üß† EmotionEngine: Definindo ${expression}`)
        AvatarEngine.applyEmotion(expression)
    }

    // =====================================================
    // PROCESSAR MENSAGEM (chamado ap√≥s resposta da LIA)
    // =====================================================

    async processMessage(
        userMessage: string,
        assistantReply: string,
        temperature: number = 5
    ): Promise<EmotionDecision> {
        // Primeiro, tentar backend GPT
        try {
            const backendResult = await this.callBackend({
                userMessage,
                assistantReply,
                emotionTemperature: temperature
            })

            if (backendResult) {
                AvatarEngine.setEmotionTemperature(temperature)
                AvatarEngine.applyEmotion(backendResult.expression)
                return backendResult
            }
        } catch (error) {
            console.warn('üß† Backend indispon√≠vel, usando fallback local')
        }

        // Fallback: an√°lise local por keywords
        const decision = this.analyzeLocally(userMessage, assistantReply, temperature)

        AvatarEngine.setEmotionTemperature(temperature)
        AvatarEngine.applyEmotion(decision.expression)

        return decision
    }

    // =====================================================
    // AN√ÅLISE LOCAL (fallback sem GPT)
    // =====================================================

    private analyzeLocally(
        userMessage: string,
        assistantReply: string,
        temperature: number
    ): EmotionDecision {
        const text = `${userMessage} ${assistantReply}`.toLowerCase()

        // Pontuar cada express√£o
        let bestExpr: ExpressionName = 'neutral'
        let bestScore = 0

        for (const [expr, keywords] of Object.entries(EMOTION_KEYWORDS)) {
            if (expr === 'neutral') continue

            let score = 0
            for (const kw of keywords) {
                if (text.includes(kw.toLowerCase())) {
                    score += 1
                }
            }

            if (score > bestScore) {
                bestScore = score
                bestExpr = expr as ExpressionName
            }
        }

        // Se nenhuma keyword, usar padr√£o baseado na temperatura
        if (bestScore === 0) {
            if (temperature >= 7) bestExpr = 'happy'
            else if (temperature >= 5) bestExpr = 'curious'
            else if (temperature >= 3) bestExpr = 'focused'
            else bestExpr = 'neutral'
        }

        console.log(`üß† EmotionEngine (local): ${bestExpr} (score: ${bestScore})`)

        return {
            expression: bestExpr,
            intensity: Math.min(1, bestScore / 3),
            reason: `keywords (score: ${bestScore})`
        }
    }

    // =====================================================
    // CHAMAR BACKEND /api/emotion-decode
    // =====================================================

    private async callBackend(request: EmotionRequest): Promise<EmotionDecision | null> {
        try {
            const response = await fetch('/api/emotion-decode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            })

            if (!response.ok) return null

            const data = await response.json()

            console.log(`üß† EmotionEngine (GPT): ${data.expression}`)

            return {
                expression: data.expression || 'neutral',
                intensity: data.intensity || 0.5,
                reason: 'GPT'
            }
        } catch {
            return null
        }
    }

    // =====================================================
    // M√âTODOS R√ÅPIDOS PARA TESTES
    // =====================================================

    testHappy() { this.setEmotion('happy') }
    testSad() { this.setEmotion('sad') }
    testSurprised() { this.setEmotion('surprised') }
    testConfused() { this.setEmotion('confused') }
    testCurious() { this.setEmotion('curious') }
    testFocused() { this.setEmotion('focused') }
    testNeutral() { this.setEmotion('neutral') }
}

// =====================================================
// SINGLETON
// =====================================================

export const EmotionEngine = new EmotionEngineClass()
export default EmotionEngine
